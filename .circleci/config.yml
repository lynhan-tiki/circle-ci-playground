version: 2.1

commands:
  custom_test:
    steps:
      - run:
          name: "Run custom test"
          command: |
            echo "Running custom test"

  custom_build:
    parameters:
      app_name:
        type: string
    steps:
      - checkout
      - run:
          name: "Should build << parameters.app_name >>"
          command: |
            ./scripts/build.sh << parameters.app_name >>

      - run:
          name: "Tigger build << parameters.app_name >>"
          command: |
            echo "Start build << parameters.app_name >>"

jobs:
  test:
    docker:
      - image: circleci/node:12.14.1
    steps:
      - checkout
  build:
    docker:
      - image: circleci/node:12.14.1
    parameters:
      app_name:
        type: string

    steps:
      - checkout
      - custom_build:
          app_name: << parameters.app_name >>

  build_miniapp:
    docker:
      - image: circleci/node:12.14.1
    steps:
      - checkout
      - custom_build:
          app_name: BUILD_MINIAPP

workflows:
  version: 2
  process_cicd:
    jobs:
      - test
      - build:
          app_name: BUILD_MWEB
          requires:
            - test
      - build:
          app_name: BUILD_MINIAPP
          requires:
            - test
